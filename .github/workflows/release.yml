# Creates a GitHub release when a tag is created
# This workflow will build the project for all Minecraft versions and attach all built artifacts to the release

name: release
on:
  create:
    tags:
      - "**"

jobs:
  build:
    strategy:
      matrix:
        # Build for all supported Minecraft versions
        minecraft_version: ["1.21.6", "1.21.8", "1.21.9", "1.21.10"]
    runs-on: ubuntu-22.04
    steps:
      - name: checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: validate gradle wrapper
        uses: gradle/wrapper-validation-action@v2
        continue-on-error: true
      - name: setup jdk 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: "microsoft"
      - name: update gradle wrapper distribution url
        run: |
          GRADLE_VERSION=$(jq -r ".[\"${{ matrix.minecraft_version }}\"].gradle_version" versions.json)
          if [ "$GRADLE_VERSION" != "null" ] && [ -n "$GRADLE_VERSION" ]; then
            GRADLE_URL="https\\://services.gradle.org/distributions/gradle-${GRADLE_VERSION}-bin.zip"
            sed -i "s|distributionUrl=.*|distributionUrl=$GRADLE_URL|" gradle/wrapper/gradle-wrapper.properties
            echo "Updated Gradle distribution URL to: https://services.gradle.org/distributions/gradle-${GRADLE_VERSION}-bin.zip"
          fi
      - name: cache gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ matrix.minecraft_version }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', 'versions.json') }}
          restore-keys: |
            ${{ runner.os }}-gradle-${{ matrix.minecraft_version }}-
            ${{ runner.os }}-gradle-
      - name: make gradle wrapper executable
        run: chmod +x ./gradlew
      - name: build for Minecraft ${{ matrix.minecraft_version }}
        run: ./gradlew build --no-daemon -Pminecraft_version=${{ matrix.minecraft_version }}
      - name: upload artifacts for ${{ matrix.minecraft_version }}
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-${{ matrix.minecraft_version }}
          path: build/libs/*.jar
          retention-days: 1

  test-server:
    needs: build
    strategy:
      matrix:
        minecraft_version: ["1.21.6", "1.21.8", "1.21.9", "1.21.10"]
    runs-on: ubuntu-22.04
    steps:
      - name: checkout repository
        uses: actions/checkout@v4
      - name: setup jdk 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: "microsoft"
      - name: download build artifact
        uses: actions/download-artifact@v4
        with:
          name: artifacts-${{ matrix.minecraft_version }}
          path: test-mod
      - name: setup test server
        run: |
          mkdir -p test-server
          cd test-server
          
          # Download Minecraft server JAR
          MC_VERSION="${{ matrix.minecraft_version }}"
          case "$MC_VERSION" in
            "1.21.6")
              SERVER_URL="https://piston-data.mojang.com/v1/objects/e6ec2f64e6080b9b5d9b471b291c33cc7f509733/server.jar"
              ;;
            "1.21.8")
              SERVER_URL="https://piston-data.mojang.com/v1/objects/8dd1a28015f51b1803213892b50b5b4fc76dfbd5/server.jar"
              ;;
            "1.21.9")
              SERVER_URL="https://piston-data.mojang.com/v1/objects/8dd1a28015f51b1803213892b50b5b4fc76dfbd5/server.jar"
              ;;
            "1.21.10")
              SERVER_URL="https://piston-data.mojang.com/v1/objects/8dd1a28015f51b1803213892b50b5b4fc76dfbd5/server.jar"
              ;;
          esac
          
          echo "Downloading Minecraft server for $MC_VERSION..."
          curl -L -o server.jar "$SERVER_URL"
          
          # Download Fabric installer
          curl -L -o fabric-installer.jar "https://maven.fabricmc.net/net/fabricmc/fabric-installer/1.0.0/fabric-installer-1.0.0.jar"
          
          # Install Fabric
          java -jar fabric-installer.jar server -mcversion "$MC_VERSION" -loader "0.17.3" -downloadMinecraft
          
          # Create mods directory and copy mod
          mkdir -p mods
          cp ../test-mod/*/*.jar mods/ 2>/dev/null || cp ../test-mod/*.jar mods/
          
          echo "Mod JARs in mods directory:"
          ls -lh mods/
      - name: test server startup
        timeout-minutes: 5
        run: |
          cd test-server
          echo "eula=true" > eula.txt
          
          # Start server and check for mod loading
          timeout 60 java -Xmx2G -Xms1G -jar fabric-server-launch.jar nogui 2>&1 | tee server.log &
          SERVER_PID=$!
          
          # Wait for server to start
          sleep 30
          
          # Check if server is running and mod loaded
          if ! kill -0 $SERVER_PID 2>/dev/null; then
            echo "ERROR: Server process died"
            cat server.log
            exit 1
          fi
          
          # Check logs for mod loading
          if grep -i "bigger.*ender.*chest" server.log || grep -i "mod.*loaded" server.log; then
            echo "SUCCESS: Mod appears to have loaded"
          else
            echo "WARNING: Could not confirm mod loading from logs"
            cat server.log
          fi
          
          # Stop server
          kill $SERVER_PID 2>/dev/null || true
          wait $SERVER_PID 2>/dev/null || true

  release:
    needs: [build, test-server]
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    steps:
      - name: checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: artifacts-*
          merge-multiple: false
          path: release-artifacts
      - name: verify artifacts and rename JARs with Minecraft version
        run: |
          echo "Listing all downloaded artifacts:"
          find release-artifacts -name "*.jar" -type f
          echo ""
          echo "Renaming JARs to include Minecraft version..."
          
          # Rename JARs to include Minecraft version in filename
          for dir in release-artifacts/artifacts-*; do
            if [ -d "$dir" ]; then
              MC_VERSION=$(basename "$dir" | sed 's/artifacts-//')
              JAR_FILE=$(find "$dir" -name "*.jar" -type f | head -1)
              if [ -n "$JAR_FILE" ]; then
                NEW_NAME="biggerenderchests-1.1.0-${MC_VERSION}.jar"
                mv "$JAR_FILE" "$dir/$NEW_NAME"
                echo "Renamed: $(basename "$JAR_FILE") -> $NEW_NAME"
              fi
            fi
          done
          
          echo ""
          echo "JAR files after renaming:"
          find release-artifacts -name "*.jar" -type f -exec ls -lh {} \;
          JAR_COUNT=$(find release-artifacts -name "*.jar" -type f | wc -l)
          echo "Total JAR files: $JAR_COUNT"
          if [ "$JAR_COUNT" -ne 4 ]; then
            echo "ERROR: Expected 4 JAR files, found $JAR_COUNT"
            exit 1
          fi
          
          # Verify all JARs have unique names with version
          echo ""
          echo "Verifying JAR filenames include Minecraft version:"
          for jar in release-artifacts/artifacts-*/*.jar; do
            if [[ "$jar" != *"-1.21."* ]]; then
              echo "ERROR: JAR filename does not include Minecraft version: $jar"
              exit 1
            fi
            echo "âœ“ $jar"
          done
      - name: get version from gradle
        id: version
        run: |
          VERSION=$(./gradlew properties -q | grep "^version:" | awk '{print $2}')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      - name: get tag name
        id: tag
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
      - name: delete old release artifacts
        run: |
          # Delete any old artifacts that don't match the versioned pattern
          gh release view ${{ steps.tag.outputs.tag }} --json assets --jq '.assets[] | select(.name | test("^biggerenderchests-.*\\.jar$") and (test("-1\\.21\\.[0-9]+\\.jar$") | not)) | .id' | while read asset_id; do
            if [ -n "$asset_id" ]; then
              echo "Deleting old asset ID: $asset_id"
              gh api -X DELETE "/repos/${{ github.repository }}/releases/assets/$asset_id" || true
            fi
          done
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      - name: create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: Release ${{ steps.tag.outputs.tag }}
          body: |
            ## Bigger Ender Chests ${{ steps.version.outputs.version }}
            
            ### Supported Minecraft Versions
            - 1.21.6
            - 1.21.8
            - 1.21.9
            - 1.21.10
            
            Built artifacts for all supported versions are attached to this release.
          files: |
            release-artifacts/artifacts-1.21.6/**/*.jar
            release-artifacts/artifacts-1.21.8/**/*.jar
            release-artifacts/artifacts-1.21.9/**/*.jar
            release-artifacts/artifacts-1.21.10/**/*.jar
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

