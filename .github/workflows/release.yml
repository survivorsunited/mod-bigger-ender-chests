# Creates a GitHub release when a tag is created
# This workflow will build the project for all Minecraft versions and attach all built artifacts to the release

name: release
on:
  create:
    tags:
      - "**"

jobs:
  build:
    strategy:
      matrix:
        # Build for all supported Minecraft versions
        minecraft_version: ["1.21.6", "1.21.8"]
    runs-on: ubuntu-22.04
    steps:
      - name: checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: validate gradle wrapper
        uses: gradle/wrapper-validation-action@v2
        continue-on-error: true
      - name: setup jdk 21
        uses: actions/setup-java@v4
        with:
          java-version: 21
          distribution: "microsoft"
      - name: update gradle wrapper distribution url
        run: |
          GRADLE_VERSION=$(jq -r ".[\"${{ matrix.minecraft_version }}\"].gradle_version" versions.json)
          if [ "$GRADLE_VERSION" != "null" ] && [ -n "$GRADLE_VERSION" ]; then
            GRADLE_URL="https\\://services.gradle.org/distributions/gradle-${GRADLE_VERSION}-bin.zip"
            sed -i "s|distributionUrl=.*|distributionUrl=$GRADLE_URL|" gradle/wrapper/gradle-wrapper.properties
            echo "Updated Gradle distribution URL to: https://services.gradle.org/distributions/gradle-${GRADLE_VERSION}-bin.zip"
          fi
      - name: cache gradle dependencies
        uses: actions/cache@v4
        with:
          path: |
            ~/.gradle/caches
            ~/.gradle/wrapper
          key: ${{ runner.os }}-gradle-${{ matrix.minecraft_version }}-${{ hashFiles('**/*.gradle*', '**/gradle-wrapper.properties', 'versions.json') }}
          restore-keys: |
            ${{ runner.os }}-gradle-${{ matrix.minecraft_version }}-
            ${{ runner.os }}-gradle-
      - name: make gradle wrapper executable
        run: chmod +x ./gradlew
      - name: build for Minecraft ${{ matrix.minecraft_version }}
        run: ./gradlew build --no-daemon -Pminecraft_version=${{ matrix.minecraft_version }}
      - name: upload artifacts for ${{ matrix.minecraft_version }}
        uses: actions/upload-artifact@v4
        with:
          name: artifacts-${{ matrix.minecraft_version }}
          path: build/libs/*.jar
          retention-days: 1

  release:
    needs: build
    runs-on: ubuntu-22.04
    permissions:
      contents: write
    steps:
      - name: checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: download all artifacts
        uses: actions/download-artifact@v4
        with:
          pattern: artifacts-*
          merge-multiple: true
          path: release-artifacts
      - name: get version from gradle
        id: version
        run: |
          VERSION=$(./gradlew properties -q | grep "^version:" | awk '{print $2}')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
      - name: get tag name
        id: tag
        run: |
          TAG_NAME=${GITHUB_REF#refs/tags/}
          echo "tag=$TAG_NAME" >> $GITHUB_OUTPUT
      - name: create release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.tag.outputs.tag }}
          name: Release ${{ steps.tag.outputs.tag }}
          body: |
            ## Bigger Ender Chests ${{ steps.version.outputs.version }}
            
            ### Supported Minecraft Versions
            - 1.21.6
            - 1.21.8
            
            Built artifacts for all supported versions are attached to this release.
          files: |
            release-artifacts/*.jar
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

